# Руководство для разработчиков

## Структура проекта
```
simple_bitcoin_wallet
├── classes
│   ├── FirstRunWindow.py
│   ├── MainWindow.py
│   └── __pycache__
├── db
├── __init__.py
├── __main__.py
├── resources
│   ├── init.sql
│   └── logo.png
├── scripts
│   ├── config.json
│   ├── consts.py
│   ├── database.py
│   ├── __pycache__
│   ├── tools.py
│   └── wallets.py
└── ui
    ├── firstrun_form.ui
    ├── form.ui
    ├── __pycache__
    ├── ui_firstrun_form.py
    └── ui_form.py
```

Основные модули (классы) для форм находятся в директории ``classes``. На текущий момент это окно первоначальной настройки и окно непосредственно приложения-кошелька.

В директории ``ui`` располагаются файлы описания интерфейса (UI-файлы редактируются через QT Creator или через QT Designer с дальнейшим преобразованием через ``pyside6-uic``)

Далее в этом руководстве описываются функции (директория ``scripts`` и структура базы данных)

## Структура базы данных и файлов конфигурации

Для хранения данных в приложении применяется СУБД SQLite3 (библиотека sqlcipher3, за исключением ОС Windows). Для хранения общедоступной информации (об адресах, транзакциях) используется ``data.db``. Для хранения секретных ключей и мнемонических фраз используется ``wallet.db`` (зашифрованная паролем через sqlcipher3, за исключением ОС Windows). 

Запросы инициализации открытой БД описаны в ``resources/init.sql``, зашифрованной в файле ``database.py`` (*функция crypt_wallet_db*)

Файл конфигурации ``config.json`` содержит сведения о каталогах расположения файлов БД, о теме, о валюте отображения (Сатоши или Биткоин), сети (тестовая или основная).

![Схема БД](https://i.imgur.com/e8JcJSx.png)



## Модули и функции

### Константы
``consts.py``

Подгружает описание констант, которые доступны (или будут доступны в дальнейшем) для изменения пользователем "на лету", из файла ``config.json`` (его структура описывается выше)

### Взаимодействие с базой данных

``database.py``

В конструкторе класса вызывается подключение к двум базам данных: зашифрованной и открытой.

Описание функций класса ``Database`` файла ``database.py``

```
init_app () - проверка существования файлов, создание таблиц в открытой БД

get_private_key (address) -> возвращает приватный (секретный) ключ, соответствующий адресу

get_last_address() -> получение последнего сгенерированного адреса из БД

get_addresses_from_db() -> получение списка всех сгенерированных адресов из БД

get_new_address_index() -> получение индекса для нового сгенерированного адреса

walletIsDeterministic() -> проверка кошелька на детерминированность

crypt_wallet_db(private_key, public_key, address, mnemonic) -> создание и шифрование файла (БД) с секретными ключами

check_password() -> проверка правильности введенного пароля

get_mnemonic() -> получение мнемонической фразы из зашифрованной БД (!только для детерминированных кошельков!)

add_keys_to_db(public_key, address) -> добавление публичного ключа и адреса в открытую БД

insert_keys(private_key, public_key, address) - добавление ключей в открытую и зашифрованную БД

transaction_is_exists(tx_hash) -> проверка существования транзакции с данным хеш-значением

add_transaction_to_db(type, sender, recipient, tx_hash, amount, fee) - добавление транзакции в базу данных

clean_transactions() -> удаление всех транзакций из БД
```
### Функции взаимодействия с кошельками

``wallets.py``

```
check_private_key(private_key) -> проверяет секретный ключ и в случае его корректности возвращает публичный ключ и адрес

add_transactions(address) -> массовое добавление транзакций в БД по адресу кошелька

generate_new_address() -> генерация новой пары ключей (!только для детерминированных кошельков!)

get_first_private_key(mnemonic) -> возвращает первый приватный ключ из первой пары ключей (с индексом 0)
```


### Взаимодействие с прочими сервисами

``tools.py``

```
qrcode_generator(content) -> генерирует qr-код для произвольной строки (используется для представления адресов, хеш-значений транзакций в наглядной форме)

get_actual_fee() -> получает актуальную информацию о комиссии по API из blockhain explorer

calc_fee(inputs, outs = 2, sat_byte = 1) -> возвращает комиссию исходя из предварительного размера транзакции, который рассчитывается по количество UTXO

get_theme_option() -> получает сведения о текущей теме приложения

change_theme_option(option) -> изменяет тему приложения
```
